<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<!--<div id="header"></div>-->
<!--<div id="map" style="width:70%;height:716px; margin-top: 0.3rem"></div>-->
<!--<ul id="placesList"></ul>-->
<!--<div id="pagination"></div>-->

<div id="header"></div>
<div id="map" style="width:70%; height:716px; margin-top: 0.3rem"></div>
<div class="searchBox">
    <input id="keyword" class="searchText" type="text" placeholder="원하는 장소를 검색해보세요">
    <button class="searchBtn" type="button" onclick="searchPlaces()">검색</button>
</div>
<ul id="placesList"></ul>
<div id="pagination"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // $(document).ready(function () {
    //     $("#header").load("/header");
    // });
    //
    // var mapContainer = document.getElementById('map'), // 지도를 표시할 div
    //     mapOption = {
    //         center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
    //         level: 3 // 지도의 확대 레벨
    //     };
    //
    // // 지도를 표시할 div와  지도 옵션으로  지도를 생성합니다
    // var map = new kakao.maps.Map(mapContainer, mapOption);

    $(document).ready(function () {

        $("#header").load("/header", function() {
            // header 로드가 완료된 후에 실행되는 코드
            var mapContainer = document.getElementById('map'); // 지도를 표시할 div
            var mapOption = {
                center: new kakao.maps.LatLng(37.5665, 126.9780), // 지도의 중심좌표
                level: 5 // 지도의 확대 레벨
            };

            // Kakao 지도 API를 비동기적으로 로드
            var script = document.createElement('script');
            script.src = '//dapi.kakao.com/v2/maps/sdk.js?appkey=b7d2b17b0b31f160b34d7bf533c7e9fb';
            document.head.appendChild(script);

            // Kakao 지도 API 스크립트가 로드되면 실행되는 함수
            script.onload = function() {
                // 지도를 생성합니다
                var map = new kakao.maps.Map(mapContainer, mapOption);
            };
        });

    });
    var markers = [];
    var ps = new kakao.maps.services.Places();
    var infowindow = new kakao.maps.InfoWindow({zIndex:1});

    function searchPlaces() {
        var keyword = document.getElementById('keyword').value;
        if (!keyword.replace(/^\s+|\s+$/g, '')) {
            alert('키워드를 입력해주세요!');
            return false;
        }
        ps.keywordSearch(keyword, placesSearchCB);
    }

    function placesSearchCB(data, status, pagination) {
        if (status === kakao.maps.services.Status.OK) {
            displayPlaces(data);
            displayPagination(pagination);
        } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
            alert('검색 결과가 존재하지 않습니다.');
        } else if (status === kakao.maps.services.Status.ERROR) {
            alert('검색 결과 중 오류가 발생했습니다.');
        }
    }

    function displayPlaces(places) {
        var listEl = document.getElementById('placesList');
        removeAllChildNodes(listEl);
        removeMarker();

        var bounds = new kakao.maps.LatLngBounds();

        for (var i = 0; i < places.length; i++) {
            var placePosition = new kakao.maps.LatLng(places[i].y, places[i].x);
            var marker = addMarker(placePosition, i, places[i].place_name);
            bounds.extend(placePosition);
            var itemEl = getListItem(i, places[i]);
            listEl.appendChild(itemEl);
        }

        map.setBounds(bounds);
    }

    function addMarker(position, idx, title) {
        var imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_blue.png';
        var imageSize = new kakao.maps.Size(36, 37);
        var imgOptions = {
            spriteSize : new kakao.maps.Size(36, 691),
            spriteOrigin : new kakao.maps.Point(0, (idx * 46) + 10),
            offset: new kakao.maps.Point(13, 37)
        };
        var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imgOptions);
        var marker = new kakao.maps.Marker({
            position: position,
            image: markerImage
        });
        marker.setMap(map);
        markers.push(marker);
        return marker;
    }

    function getListItem(index, places) {
        var el = document.createElement('li');
        var itemStr = '<span class="markerbg marker_' + (index+1) + '"></span>' +
            '<div class="info">' +
            '   <h5>' + places.place_name + '</h5>';
        if (places.road_address_name) {
            itemStr += '    <span>' + places.road_address_name + '</span>' +
                '   <span class="jibun gray">' +  places.address_name  + '</span>';
        } else {
            itemStr += '    <span>' +  places.address_name  + '</span>';
        }
        itemStr += '  <span class="tel">' + places.phone  + '</span>' +
            '</div>';
        el.innerHTML = itemStr;
        el.className = 'item';
        return el;
    }

    function removeAllChildNodes(el) {
        while (el.hasChildNodes()) {
            el.removeChild(el.lastChild);
        }
    }

    function removeMarker() {
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(null);
        }
        markers = [];
    }

    function displayPagination(pagination) {
        var paginationEl = document.getElementById('pagination');
        var fragment = document.createDocumentFragment();
        for (var i = 1; i <= pagination.last; i++) {
            var el = document.createElement('a');
            el.href = "#";
            el.innerHTML = i;
            if (i === pagination.current) {
                el.className = 'on';
            } else {
                el.onclick = (function (i) {
                    return function () {
                        pagination.gotoPage(i);
                    };
                })(i);
            }
            fragment.appendChild(el);
        }
        paginationEl.appendChild(fragment);
    }
</script>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=b7d2b17b0b31f160b34d7bf533c7e9fb"></script>
</body>
</html>